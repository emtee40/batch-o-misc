# Generate fake CA (self-signed) certificate for testing purpose
openssl req -new -x509 -newkey rsa:4096 -nodes -keyout ca.key -out ca.crt -subj '/C=FR/O=TestCA' -extensions v3_ca -batch
# (Check the certificate)
# openssl x509 -in ca.crt -text -noout

# Generate domain's certificate signing request (CSR)
openssl req -new -newkey rsa:4096 -nodes -keyout domain.key -out domain.csr -subj '/C=FR/O=TestCorp/CN=domain.tld' -batch
# (Check the CSR)
# openssl req -in domain.csr -text -noout

# Sign the CSR with the key of the CA's certificate
openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -in domain.csr -out domain.crt
# (Check the certificate)
# openssl x509 -in domain.crt -text -noout

# Sign the CSR of another domain ...
# openssl x509 -req -CA ca.crt -CAkey ca.key -CAserial ca.srl -in another-domain.csr -out another-domain.crt

# Verify the chain of trust
cat ca.crt domain.crt | openssl verify -CAfile ca.crt

# Test the certificate
openssl s_server -CAfile ca.crt -cert domain.crt -key domain.key -accept 12345
openssl s_client -connect 127.0.0.1:12345 -CAfile ca.crt < /dev/null
